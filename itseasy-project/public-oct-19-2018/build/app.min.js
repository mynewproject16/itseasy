/*
 MEAN_Test 2018-04-27 
*/

function BaseController(e,t){e.activeView=localStorage.getItem("activeView")||"jobs",t.loading=!0,e.setActiveView=function(t){t&&""!==t&&t!==e.activeView&&(e.activeView=t,localStorage.setItem("activeView",t),e.$broadcast("activeViewChanged"))}}angular.module("itsEasyApp").controller("BaseController",BaseController),BaseController.$inject=["$scope","$rootScope"],angular.module("itsEasyApp").controller("ItsEasyController",["$scope","$rootScope","$http","ItsEasyApiService","UtilityService","toastr","$uibModal","$timeout",function(e,t,a,r,n,s,i,o){e.isBusy=!1,e.dealers=[],e.corps=[],e.jobs=[],e.all_dealers=[],e.all_corps=[],e.all_jobs=[],e.search={},e.selected_jobs=[],e.current_dealer=void 0,e.current_corp=void 0,e.current_job=void 0,e.showEntriesCount=!1,e.all_selected={},e.active_user={name:""},e.selected_sheet={name:""},e.created_sheet=void 0,e.created_sheet_name={txt:""},e.printableSheets=void 0,e.dateOptions={dateDisabled:function(e){var t=e.date;return"day"===e.mode&&(0===t.getDay()||6===t.getDay())},formatYear:"yy",maxDate:new Date(2050,5,22),minDate:new Date(1920,1,1),startingDay:1},e.dateFormat="MM-dd-yyyy",e.jobDatePickers={date:{opened:!1},date_sent:{opened:!1},primary_dob:{opened:!1},coowner_dob:{opened:!1},vehicle_lease_cancel_date:{opened:!1},vehicle_lease_sign_date:{opened:!1},vehicle_purchase_date:{opened:!1}},e.openDatePicker=function(t){e.jobDatePickers[t].opened=!0},e.getAll=function(){r.getAll(function(t){["dealers","corps","jobs","sheets"].forEach(function(a){"sheets"!==a?("jobs"===a&&t&&t.data.jobs&&t.data.jobs.forEach(function(t){t.dealer_id&&t.dealer_id.length&&(t.dealer=e.all_dealers.filter(function(e){return t.dealer_id===e._id})[0]),t.last_name_table=t.primary_last_name&&t.primary_last_name.length?t.primary_last_name:t.primary_company}),e[a]=t.data&&t.data[a],e["all_"+a]=JSON.parse(JSON.stringify(e[a])),e.updateTables(a)):"sheets"===a&&t&&t.data.sheets&&(e.printableSheets=t.data.sheets.filter(function(e){var t=new Date(e.created_at),a=new Date;return t.getDate()==a.getDate()&&t.getMonth()==a.getMonth()&&t.getFullYear()==a.getFullYear()}))}),e.showEntriesCount=e.tables[e.activeView].current_page_data.length<=e.tables[e.activeView].total_items},function(e){})},e.getAll(),e.updateTables=function(t){e.tables[t].current_page_data=e.getCurrentPageData(t),e.tables[t].total_items=e[t].length,e.tables[t].has_next_data=e.dataExists(t,"next"),e.tables[t].has_prev_data=e.dataExists(t,"prev")},e.create=function(t){e.isBusy||(e.isBusy=!0,r.create(t,e["current_"+t],function(a){e.isBusy=!1,e[t+"s"].unshift(a.data),e["current_"+t]=e[t+"s"][0],e.tables[t+"s"].current_page=1,e.pageChanged(t+"s"),"jobs"===e.activeView&&"job"!==t?(e.updateIdsOnCurrentJob(a.data._id),e.formSubmitted("job")):s.success(t+" created!")},function(a){e.isBusy=!1,s.error("Error while creating "+t)}))},e.save=function(t){var a=e["current_"+t];e.isBusy||(e.isBusy=!0,r.update(a._id,t,a,function(a){var r;e.isBusy=!1,e[t+"s"].forEach(function(e,t){e._id===a.data._id&&(r=t)}),e[t+"s"][r]=a.data,e["current_"+t]=e[t+"s"][r],"jobs"===e.activeView&&"job"!==t?(e.updateIdsOnCurrentJob(a.data._id),e.formSubmitted("job")):s.success(t+" updated!")},function(a){e.isBusy=!1,s.error("Error while updating "+t)}))},e.remove=function(t){var a,r=e["current_"+t];e.isBusy||e[t+"s"].forEach(function(n,s){n._id===r._id&&(a=s,i.open({animation:!0,ariaLabelledBy:"modal-title-top",ariaDescribedBy:"modal-body-top",templateUrl:"partials/confirm-delete.html",size:"sm",scope:e,resolve:{data:{item:t,currentObj:r,idxToDelete:a}},controller:"ItsEasyConfirmDeleteController"}))})},e.select=function(t,a){if($('a[href="#job_details"]').parent().hasClass("active")){if("job"===t)return;if($("#dealer").hasClass("active")&&"crop"===t)return}var r,n;e.tables[t+"s"].current_page_data[a].selected?(e.tables[t+"s"].current_page_data[a].selected=!1,(n=(r=e.getSelectedData(t))?r.length:0)?e["current_"+t]=r[n-1]:n||(e["current_"+t]=void 0)):("dealer"!==t&&"corp"!==t||(e["current_"+t]=void 0,e.tables[t+"s"].current_page_data.forEach(function(e){e.selected=!1})),e["current_"+t]=e.tables[t+"s"].current_page_data[a],e.tables[t+"s"].current_page_data[a].selected=!0),e.selected_jobs=e.selected_jobs.concat(e.tables.jobs.current_page_data.filter(function(e){return e.selected}))},e.editClicked=function(t,a){if(a&&a.preventDefault(),angular.element("a[href='#information']").trigger("click"),angular.isUndefined(e["current_"+t]))return s.error("Please select "+t+" or click add");if($('a[href="#'+t+'_details"]').tab("show"),"job"===t){var r=e.current_job;-1==="Geico All State Esurance State Farm Progressive".indexOf(r.vehicle_insurance_company)&&$(".insurance-company > option:nth-child(1)").after("<option selected=true>"+r.vehicle_insurance_company+"</option>")}},e.addClicked=function(t){e["current_"+t]={created_by:e.active_user.name},e.current_dealer={},e.current_corp={},angular.element("a[href='#information']").trigger("click"),"job"===t&&(e.current_job.trans_type="INITIAL",e.current_job.lease_or_buy="lease",e.current_job.initial=!0,e.current_job.date=new Date,e.current_job.initial=e.current_job.trans=e.current_job.renew=e.current_job.rep_pl=e.current_job.dupl=e.current_job.comm=e.current_job.rental=e.current_job.hold=!1),$('a[href="#'+t+'_details"]').tab("show")},e.deleteClicked=function(t){e.remove(t)},e.formSubmitted=function(t){"job"===t&&(["date_sent","date","primary_dob","coowner_dob","vehicle_lease_cancel_date","vehicle_lease_sign_date","vehicle_purchase_date"].forEach(function(t){var a=angular.element("[ng-model='current_job."+t+"']").val();a&&a.length>0&&(e.current_job[t]=a)}),e.current_job.vehicle_insurance_company_text&&e.current_job.vehicle_insurance_company_text.length&&(e.current_job.vehicle_insurance_company=e.current_job.vehicle_insurance_company_text)),e["current_"+t]._id?e.save(t):e.create(t)},e.tables={},e.user={name:"",password:""},e.getCurrentPageData=function(t){var a=e.tables[t].current_page-1,r=Number(e.tables[t].items_per_page);return e[t].slice(r*a,r*a+r)},e.dataExists=function(t,a){return"next"===a?e.tables[t].current_page*e.tables[t].items_per_page<e.tables[t].total_items:"prev"===a?e.tables[t].current_page>1:void 0},["dealer","corp","job"].forEach(function(t){var a={current_page:1,items_per_page:5};e.tables[t+"s"]=a,e["curr_"+t]=void 0,e["curr_"+t+"_idx"]=void 0}),e.pageChanged=function(t,a){"next"===a&&e.dataExists(t,"next")&&(e.tables[t].current_page++,e.tables[t].current_page_data=e.getCurrentPageData(t)),"prev"===a&&e.dataExists(t,"prev")?(e.tables[t].current_page--,e.tables[t].current_page_data=e.getCurrentPageData(t)):e.tables[t].current_page_data=e.getCurrentPageData(t),e.tables[t].has_prev_data=e.dataExists(t,"prev"),e.tables[t].has_next_data=e.dataExists(t,"next")},e.selectAll=function(t){for(var a=0;a<e.tables[t].current_page_data.length;a++)e.all_selected[t]?e.tables[t].current_page_data[a].selected=!0:e.tables[t].current_page_data[a].selected=!1},o(function(){t.loading=!1,angular.element(".get_user_modal").modal()},500),e.userSelected=function(){e.active_user.name.length&&angular.element(".get_user_modal").modal("hide")},e.createForms=function(){r.getForms(e.current_job._id,function(e){angular.element(".pdf").removeClass("disabled")},function(e){})},e.updateForJob=function(t){$(".pdf").addClass("disabled"),"dealer"===t?e.current_dealer=e.dealers.filter(function(a){return e.current_job[t+"_id"]===a._id})[0]||{}:e.current_corp=e.corps.filter(function(a){return e.current_job[t+"_id"]===a._id})[0]||{},e.clearFilter()},e.updateIdsOnCurrentJob=function(t){switch(angular.element("#job_details li.active a").text().toLowerCase()){case"dealer":e.current_job.dealer_id=t;break;case"lessor":e.current_job.lessor_id=t;break;case"liens":e.current_job.lien_id=t}},e.getSelectedData=function(t){for(var a=[],r=0;r<e.tables[t+"s"].current_page_data.length;r++)e.tables[t+"s"].current_page_data[r].selected&&a.push(e.tables[t+"s"].current_page_data[r]);return a},e.printSheet=function(){e.selected_sheet.state="",angular.element(".print_sheet_modal").modal()},e.sheetSelected=function(){e.selected_sheet.state="PROCESSING",angular.element(".printable-sheets").addClass("hide");var t="";e.selected_jobs.forEach(function(e){t+=e._id+"__"}),t.length>0&&(t=t.slice(0,-2),r.getSheet({job_ids:t,sheet_name:e.selected_sheet.name},function(t){e.selected_sheet.state="READY",e.created_sheet=t.data.data},function(t){e.selected_sheet.state="",$(".modal").modal("hide")}))},e.$on("activeViewChanged",function(t){e.clearFilter(),e.showEntriesCount=e.tables[e.activeView].current_page_data.length<=e.tables[e.activeView].total_items}),e.filterTable=function(t){var a;(a={corps:["name","corp_code","city","state","zip","fed_tax_id"],dealers:["name","city","state","zip"],jobs:["vehicle_vin","primary_last_name","vehicle_insurance_company","dealer_name"]}[t].filter(function(t){return e.search[t]&&e.search[t].length})[0])&&a.length&&(e[t]=e["all_"+t].filter(function(r){var n=!1,s=e.search[a];if("jobs"===t&&"dealer_name"===a){var i=r.dealer_id;if(r.dealer_id==i){var o=e.all_dealers.filter(function(e){return""+i==""+e._id})[0];o&&0===o.name.toLowerCase().indexOf(s.toLowerCase())&&(n=!0)}}else r[a]&&0===r[a].toLowerCase().indexOf(s.toLowerCase())&&(n=!0);return n}),e.updateTables(t),e.showEntriesCount=e.tables[e.activeView].current_page_data.length<=e.tables[e.activeView].total_items)},e.clearFilter=function(){["dealers","jobs","corps"].forEach(function(t){e[t]=e["all_"+t],e.updateTables(t),e.search={}}),e.showEntriesCount=e.tables[e.activeView].current_page_data.length<=e.tables[e.activeView].total_items},e.sellerSameAsDealerChoice=function(){e.updateForJob("dealer"),e.current_job.seller_dealer_same&&["name","address1","address2","city","state","zip","state","zip","corp_code"].forEach(function(t){e.current_job["seller_"+t]=e.current_dealer[t]})},e.companyOrIndividualChosen=function(){e.current_job.primary_first_name=e.current_job.primary_middle_name=e.current_job.primary_last_name=e.current_job.primary_company=""},e.updateJobStatus=function(t){r.update(t._id,"job",{status:t.status},function(t){e.isBusy=!1,s.success("Status Updated.")},function(t){e.isBusy=!1,s.error("Error while updating Status.")})},e.saveSheet=function(t){e.isBusy=!0,r.create("sheet",{created_sheet_file_name:t,created_sheet_name:e.created_sheet_name.txt},function(t){e.isBusy=!1,s.success("Sheet Saved.")},function(t){e.isBusy=!1,s.error("Error saving sheet.")})}}]),angular.module("itsEasyApp").controller("ItsEasyConfirmDeleteController",["$scope","$uibModalInstance","ItsEasyApiService","data","toastr",function(e,t,a,r,n){e.delete=function(){e.isBusy=!0,a.remove(r.currentObj._id,r.item,function(a){e.isBusy=!1,e.$parent.tables[r.item+"s"].current_page_data.splice(r.idxToDelete,1),n.success(r.item+" deleted!"),t.close("ok")},function(t){e.isBusy=!1,n.error("Error while deleting "+r.item)})},e.cancel=function(){t.close("cancel")}}]),angular.module("itsEasyApp").service("ItsEasyApiService",["$http",function(e){this.getAll=function(t,a){return e.get("/api/get-all").then(t,a)},this.create=function(t,a,r,n){return e.post("/api/"+t+"/create",a).then(r,n)},this.update=function(t,a,r,n,s){return e.put("/api/"+a+"/update/"+t,r).then(n,s)},this.remove=function(t,a,r,n){return e.delete("/api/"+a+"/delete/"+t).then(r,n)},this.register=function(t,a,r){return e.post("/api/login/",t).then(a,r)},this.getForms=function(t,a,r){return e.get("/api/forms/"+t).then(a,r)},this.getSheet=function(t,a,r){return e.get("/api/job/get-sheet/"+t.sheet_name+"/"+t.job_ids).then(a,r)}}]),angular.module("itsEasyApp").service("UtilityService",[function(){}]),$(document).ready(function(){var e={el:{ham:$(".menu")},init:function(){e.bindUIactions()},bindUIactions:function(){e.el.ham.on("touchstart click",function(t){t.preventDefault(),e.activateMenu(t)})},activateMenu:function(){e.el.ham.toggleClass("menu-opened")}};e.init(),$(function(){var e=$(".back_to_top");$(window).scroll(function(){$(window).scrollTop()>=400?$(e).addClass("active"):$(e).removeClass("active")})})}),angular.module("itsEasyApp").directive("formatDateModel",function(){return{require:"ngModel",link:function(e,t,a,r){r.$formatters.push(function(e){return new Date(e)})}}}).directive("numberModelToString",function(){return{restrict:"A",require:"ngModel",link:function(e,t,a,r){r.$formatters.push(function(e){return e?e.toString():void 0})}}}),angular.module("itsEasyApp").filter("itseToDate",[function(){return function(e){return new Date(e)}}]);